cache:                                                                                                                               
  key: ${CI_COMMIT_REF_SLUG}
  paths:
  - .m2
  - .sonar/cache

stages:
  - build
  - quality

variables:
  MAVEN_USER: 'deployment'
  COUCHDB_USER: "user"
  COUCHDB_PASSWORD: "password"
  MAVEN_CLI_OPTS: "--batch-mode -Dmaven.repo.local=$CI_PROJECT_DIR/.m2 -DCOUCHDB_TEST_URL=http://${COUCHDB_USER}:${COUCHDB_PASSWORD}@couchdb:5984"
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  SONAR_HOST_URL: 'https://sonar.geomatys.com'
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task

build-linux:
  image: images.geomatys.com/maven:3-jdk8-openjfx
  stage: build
  services:
    - couchdb:3.1.1
  script:
    # Import certificate to fulfill part 5 of the readme
    - keytool -importcert -file $CERTIFICATE -alias certificate -keystore $JAVA_HOME/jre/lib/security/cacerts -storepass changeit -noprompt
    # Do a clean build
    - mvn clean install $MAVEN_CLI_OPTS -s $MAVEN_SETTINGS -Pall -Dtest=!fr.sirs.DesignationIncrementerTest -DfailIfNoTests=false
    # Build native JFX packages
    - cd launcher
    - apt update
    - apt install -yqq fakeroot rpm
    - mvn jfx:native $MAVEN_CLI_OPTS -s $MAVEN_SETTINGS
  artifacts:
    paths:
      - launcher/target/jfx/native
      - plugin-*

build-windows:
  stage: build
  tags:
    - powershell
  services:
    - couchdb:3.1.1
  variables:
    MAVEN_CLI_OPTS: "--batch-mode" #-Dmaven.repo.local=$CI_PROJECT_DIR\\.m2"
  script:
    - cd $env:CI_PROJECT_DIR\
    #- keytool -importcert -file $CERTIFICATE -alias certificate -storepass changeit -noprompt
    - mvn clean install $MAVEN_CLI_OPTS -s $MAVEN_SETTINGS -Pall -DfailIfNoTests=false
    - cd launcher
    - mvn jfx:native $MAVEN_CLI_OPTS -s $MAVEN_SETTINGS
  artifacts:
    paths:
      - launcher/target/jfx/native
      - plugin-*

build-macosx:
  stage: build
  tags:
    - macosx
  services:
    - couchdb:3.1.1
  script:
    #- keytool -importcert -file $CERTIFICATE -alias certificate -storepass changeit -noprompt
    - mvn clean install $MAVEN_CLI_OPTS -s $MAVEN_SETTINGS -Pall -Dtest=!fr.sirs.DesignationIncrementerTest -DfailIfNoTests=false
    - cd launcher
    - mvn jfx:native $MAVEN_CLI_OPTS -s $MAVEN_SETTINGS
  artifacts:
    paths:
      - launcher/target/jfx/native
      - plugin-*

quality:
  image: images.geomatys.com/ci/maven:3-jdk-8-openjfx
  stage: quality
  script:
    - mvn sonar:sonar $MAVEN_CLI_OPTS -s $MAVEN_SETTINGS
      -Dsonar.login=$SONAR_TOKEN
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.java.binaries=${CI_PROJECT_DIR}/.m2
      $MAVEN_CLI_OPTS -s $SETTINGS_MAVEN
  allow_failure: true
  only:
    variables:
      - $SONAR_TOKEN
